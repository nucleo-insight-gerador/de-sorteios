<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nucleo Insight | System</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://i.ibb.co/nMt8zB1d/LOGO-01.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ffd700; --bg: #050505; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; background-image: radial-gradient(circle at 50% 10%, #1a1a00 0%, #000 90%); }
        #neural-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.3; pointer-events: none; }
        .z-content { position: relative; z-index: 50; }
        
        .btn-google { background: #fff; color: #000; border: none; border-radius: 8px; padding: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; font-size: 14px; cursor: pointer; margin-top: 10px; width: 100%; transition: transform 0.2s; }
        .btn-google:active { transform: scale(0.95); }
        
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; position: relative; z-index: 2; }
        .screen.active { display: flex; animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS RESUMIDOS PARA ECONOMIZAR ESPA√áO VISUAL */
        .btn-pulse { background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%); border: none; color: #000; padding: 20px; font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 18px; text-transform: uppercase; border-radius: 12px; cursor: pointer; width: 100%; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .game-card { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; }
        .game-card.active { border-color: var(--primary); background: rgba(255, 215, 0, 0.15); }
        
        .result-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 30px 0; }
        .ball { width: 48px; height: 48px; background: #111; border: 1px solid #444; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #111; border: 1px solid var(--primary); padding: 30px; border-radius: 16px; width: 90%; text-align: center; }
        .input-box { background: #111; border: 1px solid #333; color: #fff; padding: 15px; width: 100%; border-radius: 8px; margin-bottom:10px; }
    </style>
</head>
<body>

    <canvas id="neural-canvas"></canvas>

    <div id="paywallModal" class="modal-overlay">
        <div class="modal-box">
            <i data-lucide="lock" size="48" class="text-gold" style="margin-bottom: 20px;"></i>
            <h2 style="color:#fff; font-size:20px; margin-bottom:10px;">LIMITE ATINGIDO</h2>
            <p style="color:#888; font-size:14px; margin-bottom:25px;">Recalibragem necess√°ria.</p>
            <button onclick="openVipLink()" class="btn-pulse" style="font-size:14px; padding:15px;">DESBLOQUEAR TUDO</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#555; margin-top:15px;">Fechar</button>
        </div>
    </div>

    <div id="screen-home" class="screen active z-content" style="justify-content: center; align-items: center; text-align: center;">
        <img src="https://i.ibb.co/nMt8zB1d/LOGO-01.png" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; border:2px solid var(--primary);">
        <h1 style="font-size: 32px; font-weight: 800; color: #fff; letter-spacing: 2px;">NUCLEO <span style="color:var(--primary)">INSIGHT</span></h1>
        <p style="color:#666; font-size:10px; letter-spacing:4px; margin-bottom:40px;">QUANTUM INTELLIGENCE v5.6</p>
        
        <div style="width:100%; max-width:300px;">
            <button id="btnLogin" class="btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> 
                ENTRAR COM GOOGLE
            </button>
            <p id="statusLog" style="color:#ffd700; font-size:10px; margin-top:15px; display:none;">Verificando credenciais...</p>
        </div>
    </div>

    <div id="screen-ritual" class="screen z-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div style="font-size:10px; color:#666;">ID: <span id="userIdDisplay">...</span></div>
            <div style="font-size:10px; color:var(--primary);">CR√âDITOS: <span id="usageCount">...</span></div>
        </div>

        <div class="game-grid">
            <div class="game-card active" onclick="selectGame('lotofacil', this)">üçÄ LOTOF√ÅCIL</div>
            <div class="game-card" onclick="selectGame('mega', this)">üí∞ MEGA SENA</div>
            <div class="game-card" onclick="selectGame('quina', this)">üî∑ QUINA</div>
            <div class="game-card" onclick="selectGame('bicho', this)">ü¶Å PALPITE</div>
        </div>
        
        <input type="hidden" id="gameType" value="lotofacil">
        <input type="text" id="dreamInput" class="input-box" placeholder="DIGITE O SONHO..." style="display:none;">

        <div style="margin-top:auto;"><button onclick="checkLimitAndStart()" class="btn-pulse">DECODIFICAR PADR√ÉO</button></div>
    </div>

    <div id="screen-loading" class="screen z-content" style="justify-content:center; align-items:center;">
        <i data-lucide="cpu" size="64" style="color:var(--primary); animation:pulse 1s infinite;"></i>
        <div style="margin-top:20px; color:#fff; font-family:'JetBrains Mono'">PROCESSANDO...</div>
    </div>

    <div id="screen-result" class="screen z-content">
        <div style="text-align:center; margin-top:20px;">
            <h2 style="font-size:12px; letter-spacing:2px; color:#666; margin-bottom:10px;">SEQU√äNCIA DECODIFICADA</h2>
            <div id="numbersGrid" class="result-grid"></div>
            <div id="animalResult" style="display:none; font-size:24px; color:var(--primary); font-weight:800; margin-bottom:20px;"></div>
        </div>
        <div style="margin-top:auto;">
            <button onclick="resetApp()" class="btn-google" style="background:#111; color:#fff; border:1px solid #333;">NOVA AN√ÅLISE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // CHAVES ORIGINAIS
        const firebaseConfig = { apiKey: "AIzaSyCga2CVSKysTYUpY3RDZNyV5BXhJe32lJQ", authDomain: "nucleo-insight-gerador.firebaseapp.com", projectId: "nucleo-insight-gerador", storageBucket: "nucleo-insight-gerador.firebasestorage.app", messagingSenderId: "159624822756", appId: "1:159624822756:web:279e5e1d4e0b80bc4991f1" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const provider = new GoogleAuthProvider();
        
        let currentUser = null; let currentNumbers = []; let currentMode = 'lotofacil'; let userUsage = 0; let isVip = false;
        const isTestMode = window.location.search.includes('mode=test');
        const DAILY_LIMIT = 5;

        // --- SISTEMA DE REDIRECT PURO (SOLU√á√ÉO DE LOGIN) ---
        // 1. Verifica se o usu√°rio acabou de voltar do Google
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log("Voltou do Google com sucesso!", result.user);
                    document.getElementById('statusLog').style.display = "block";
                    document.getElementById('statusLog').innerText = "Login confirmado! Entrando...";
                }
            }).catch((error) => {
                console.error(error);
                alert("Erro no Login: " + error.message);
            });

        // 2. Monitora estado do usu√°rio
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if(!isTestMode) logEvent(analytics, 'login');
                document.getElementById('userIdDisplay').innerText = user.email.split('@')[0];
                showScreen('screen-ritual');
                checkServerUsage();
            } else {
                showScreen('screen-home');
            }
        });

        // 3. Bot√£o inicia o Redirect (Sai da p√°gina e vai pro Google)
        document.getElementById('btnLogin').addEventListener('click', () => {
            document.getElementById('statusLog').style.display = "block";
            signInWithRedirect(auth, provider);
        });

        // --- BACKGROUND ---
        const canvas = document.getElementById('neural-canvas'); const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        class Particle { constructor() { this.x = Math.random()*width; this.y = Math.random()*height; this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5; } update() { this.x += this.vx; this.y += this.vy; if(this.x<0||this.x>width) this.vx*=-1; if(this.y<0||this.y>height) this.vy*=-1; } draw() { ctx.fillStyle = 'rgba(255, 215, 0, 0.2)'; ctx.fillRect(this.x, this.y, 2, 2); } }
        function initParticles() { particles = []; for(let i=0; i<40; i++) particles.push(new Particle()); }
        function animate() { ctx.clearRect(0,0,width,height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        window.addEventListener('resize', resize); resize(); initParticles(); animate();

        // --- L√ìGICA DO APP ---
        window.selectGame = (mode, el) => {
            currentMode = mode; document.getElementById('gameType').value = mode;
            document.querySelectorAll('.game-card').forEach(c => c.classList.remove('active')); el.classList.add('active');
            const inp = document.getElementById('dreamInput');
            inp.style.display = (mode === 'bicho') ? 'block' : 'none';
        }

        async function fetchRealLotteryData(mode) {
            const map = {'lotofacil': 'lotofacil', 'mega': 'megasena', 'quina': 'quina'};
            if(!map[mode]) return null;
            try { const r = await fetch(`https://loteriascaixa-api.herokuapp.com/api/${map[mode]}`); return r.ok ? await r.json() : null; } catch(e) { return null; }
        }

        async function checkServerUsage() {
            if (!currentUser) return;
            const today = new Date().toDateString(); const ref = doc(db, "usage", currentUser.uid);
            try { const snap = await getDoc(ref); if(snap.exists()) { const d = snap.data(); if(d.date===today) userUsage=d.count; else { userUsage=0; await setDoc(ref,{date:today,count:0,email:currentUser.email},{merge:true}); } if(d.isVip) isVip=true; } else { userUsage=0; await setDoc(ref,{date:today,count:0,email:currentUser.email,isVip:false}); } updateUI(); } catch(e){}
        }

        async function increment() { if(!currentUser || isVip || isTestMode) return; const today=new Date().toDateString(); const ref=doc(db,"usage",currentUser.uid); userUsage++; await updateDoc(ref,{count:userUsage,date:today}); updateUI(); }
        function updateUI() { const d = document.getElementById('usageCount'); if(isTestMode) { d.innerText = "TEST"; d.style.color = "#4488ff"; } else if(isVip) { d.innerText = "‚àû"; d.style.color = "#00ff88"; } else { d.innerText = `${userUsage}/5`; d.style.color = userUsage>=DAILY_LIMIT?"#ff4444":"#ffd700"; } }
        
        window.checkLimitAndStart = async () => { if(!isTestMode && !isVip && userUsage >= DAILY_LIMIT) { document.getElementById('paywallModal').style.display = 'flex'; return; } startProcessing(); }

        window.startProcessing = () => {
            showScreen('screen-loading');
            setTimeout(() => { generateResult(); }, 2500);
        }

        async function generateResult() {
            await increment();
            const grid = document.getElementById('numbersGrid'); const animalRes = document.getElementById('animalResult');
            grid.innerHTML = ''; animalRes.style.display = 'none'; currentNumbers = [];
            
            let isSafe = true; let realData = null;
            if(currentMode!=='bicho') realData = await fetchRealLotteryData(currentMode);

            if (currentMode === 'bicho') {
                const animals = ["","Avestruz","√Åguia","Burro","Borboleta","Cachorro","Cabra","Carneiro","Camelo","Cobra","Coelho","Cavalo","Elefante","Galo","Gato","Jacar√©","Le√£o","Macaco","Porco","Pav√£o","Peru","Touro","Tigre","Urso","Veado","Vaca"];
                let group = Math.floor(Math.random()*25)+1;
                let base = (group-1)*4+1; currentNumbers=[base,base+1,base+2,base+3];
                animalRes.innerText = `ü¶Å ${animals[group]}`; animalRes.style.display='block';
                currentNumbers.forEach(n => addBall(n, grid));
            } else {
                let max=25, count=15; if(currentMode==='mega'){max=60;count=6;} if(currentMode==='quina'){max=80;count=5;}
                let nums = new Set();
                if(realData) { let last = realData.dezenas.map(d=>parseInt(d)); for(let i=0; i<Math.floor(count/2); i++) nums.add(last[i]); }
                while(nums.size < count) nums.add(Math.floor(Math.random() * max) + 1);
                currentNumbers = Array.from(nums).sort((a,b)=>a-b);
                currentNumbers.forEach(n => addBall(n, grid));
            }

            if(currentUser) { await addDoc(collection(db, "history"), { uid: currentUser.uid, email: currentUser.email, numbers: currentNumbers, mode: currentMode, isTest: isTestMode, createdAt: serverTimestamp() }); }
            showScreen('screen-result');
        }

        function addBall(n, grid) { const d = document.createElement('div'); d.className = 'ball'; d.innerText = n<10?'0'+n:n; grid.appendChild(d); }
        window.openVipLink = () => { if(isTestMode) return alert("Teste"); window.open("https://pay.kiwify.com.br/MuUU7j8", "_blank"); }
        window.closeModal = () => { document.getElementById('paywallModal').style.display = 'none'; }
        window.resetApp = () => showScreen('screen-ritual');
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        lucide.createIcons();
    </script>
</body>
</html>
