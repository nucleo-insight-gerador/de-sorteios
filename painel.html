<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comando Central | Nucleo Insight</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.ibb.co/nMt8zB1d/LOGO-01.png">

    <style>
        /* --- ESTILO "OLD SCHOOL" RESTAURADO --- */
        body { background-color: #000000; color: #a5b4fc; font-family: 'JetBrains Mono', monospace; background-image: radial-gradient(circle at 50% 0%, #1a1a00 0%, #000 70%); }
        
        /* Pain√©is de Vidro Escuro */
        .glass-panel { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }
        
        /* Tipografia */
        .metric-value { font-size: 1.8rem; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
        .metric-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: bold; }
        
        /* O FUNIL */
        .funnel-step { position: relative; padding-left: 25px; border-left: 2px solid #333; margin-bottom: 25px; }
        .funnel-step:last-child { border-left: 2px solid transparent; } 
        
        .funnel-dot { 
            position: absolute; left: -6px; top: 0; width: 10px; height: 10px; 
            background: #ffd700; border-radius: 50%; box-shadow: 0 0 10px #ffd700;
            z-index: 10;
        }
        
        .progress-bar-bg { background: #222; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; background: #ffd700; width: 0%; transition: width 1s; box-shadow: 0 0 5px #ffd700; }
        
        /* Bot√µes de Ferramentas */
        .btn-tool { 
            display: flex; align-items: center; gap: 8px; padding: 10px 14px; 
            border-radius: 8px; font-size: 11px; font-weight: bold; transition: all 0.2s; 
            border: 1px solid rgba(255,255,255,0.05); background: #0a0a0a; 
        }
        .btn-tool:hover { border-color: #ffd700; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1); }
        
        /* Bot√£o Perigo (Delete) */
        .btn-danger { border-color: rgba(220, 38, 38, 0.3); color: #f87171; }
        .btn-danger:hover { border-color: #ef4444; background: rgba(220, 38, 38, 0.1); box-shadow: 0 0 15px rgba(220, 38, 38, 0.2); }

        /* Cards Coloridos */
        .stat-card { border-left: 3px solid; padding-left: 15px; background: rgba(255,255,255,0.02); transition: transform 0.2s; }
        .stat-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.04); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ffd700; }

        /* Modal Wipe */
        .modal-wipe { background: rgba(20, 0, 0, 0.95); border: 1px solid #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="login-overlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="text-center p-8 border border-yellow-900/50 rounded-xl bg-zinc-900/50 backdrop-blur">
            <img src="https://i.ibb.co/nMt8zB1d/LOGO-01.png" class="w-16 h-16 mx-auto mb-4 animate-pulse">
            <h1 class="text-2xl text-yellow-500 font-black mb-1 tracking-widest">NUCLEO INSIGHT</h1>
            <p class="text-xs text-gray-500 mb-6">√ÅREA RESTRITA</p>
            <button id="btnLogin" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-yellow-400 hover:text-black transition flex items-center gap-2 mx-auto">
                <i data-lucide="lock" size="16"></i> Acessar Painel
            </button>
        </div>
    </div>

    <div id="wipe-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="modal-wipe p-8 rounded-xl max-w-md w-full shadow-2xl relative">
            <button onclick="closeWipeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            
            <div class="flex items-center gap-3 text-red-500 mb-4">
                <i data-lucide="alert-triangle" size="32"></i>
                <h2 class="text-xl font-black uppercase tracking-widest">Zona de Perigo</h2>
            </div>
            
            <p class="text-gray-400 text-xs mb-6">Esta a√ß√£o apagar√° permanentemente os registros do banco de dados. Um log desta a√ß√£o ser√° salvo.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500">O que voc√™ quer zerar?</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="wipeType" value="test" checked class="accent-red-500">
                            <span class="text-sm text-blue-400 font-bold">DADOS DE TESTE</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="wipeType" value="real" class="accent-red-500">
                            <span class="text-sm text-yellow-500 font-bold">CLIENTES REAIS</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500">Motivo (Obrigat√≥rio para Hist√≥rico):</label>
                    <input type="text" id="wipeReason" class="w-full bg-black border border-red-900/50 rounded p-3 text-white text-sm mt-1 focus:border-red-500 outline-none" placeholder="Ex: Limpeza para lan√ßamento...">
                </div>

                <button onclick="confirmWipe()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black py-3 rounded uppercase tracking-widest transition mt-4 flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" size="16"></i> CONFIRMAR LIMPEZA
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="max-w-7xl mx-auto hidden animate-fade-in">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-800 pb-6 gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/nMt8zB1d/LOGO-01.png" class="w-12 h-12 border border-yellow-500/30 rounded-lg p-1">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-widest">NUCLEO <span class="text-yellow-500">INSIGHT</span></h1>
                    <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest">Comando Central v4.1</p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="openWipeModal()" class="btn-tool btn-danger">
                    <i data-lucide="trash" size="14"></i> LIMPAR DADOS
                </button>
                <div class="w-[1px] h-8 bg-gray-800 mx-2"></div>
                <a href="https://clarity.microsoft.com/projects/view/v018s4v24n/dashboard" target="_blank" class="btn-tool text-orange-400">
                    <i data-lucide="flame" size="14"></i> CLARITY
                </a>
                <a href="https://console.firebase.google.com/u/0/project/nucleo-insight-gerador/analytics/dashboard" target="_blank" class="btn-tool text-yellow-400">
                    <i data-lucide="bar-chart-2" size="14"></i> ANALYTICS
                </a>
                <a href="https://business.facebook.com/events_manager" target="_blank" class="btn-tool text-blue-400">
                    <i data-lucide="facebook" size="14"></i> PIXEL ADS
                </a>
            </div>
        </header>

        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                <span class="text-xs font-bold text-emerald-500 uppercase tracking-widest">Sistema Online</span>
            </div>

            <div class="flex items-center gap-3 bg-zinc-900/80 p-2 rounded border border-zinc-800">
                <span class="text-[10px] text-gray-400 font-bold uppercase">Visualizar:</span>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-test" class="sr-only peer" onchange="loadData()">
                    <div class="w-10 h-5 bg-emerald-900 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600"></div>
                    <span id="mode-label" class="ml-2 text-[10px] font-bold text-emerald-500">CLIENTES REAIS</span>
                </label>
                <button onclick="loadData()" class="ml-2 text-gray-500 hover:text-white transition"><i data-lucide="refresh-cw" size="14"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 glass-panel p-6">
                <h2 class="text-xs font-bold text-yellow-500 mb-8 flex items-center gap-2 uppercase tracking-widest">
                    <i data-lucide="filter" size="14"></i> Funil de Convers√£o
                </h2>
                <div id="funnel-container" class="space-y-2">
                    <div class="text-center text-gray-600 text-xs py-10 animate-pulse">Carregando dados...</div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-panel p-4 stat-card border-yellow-500">
                        <p class="metric-label">Jogos Gerados</p>
                        <p id="kpi-total" class="metric-value">0</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-blue-500">
                        <p class="metric-label">Modo Preferido</p>
                        <p id="kpi-fav" class="text-lg font-bold text-white mt-1 truncate">...</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-purple-500">
                        <p class="metric-label">Ousadia M√©dia</p>
                        <p id="kpi-risk" class="metric-value">0%</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-green-500">
                        <p class="metric-label">Checkout (Est.)</p>
                        <p id="kpi-sales" class="metric-value">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 flex flex-col items-center justify-center">
                        <h3 class="text-[10px] font-bold text-gray-400 mb-4 uppercase tracking-widest self-start">Distribui√ß√£o</h3>
                        <div class="w-40 h-40 relative">
                            <canvas id="gameChart"></canvas>
                        </div>
                        <div id="legend-container" class="mt-4 w-full space-y-1"></div>
                    </div>

                    <div class="glass-panel p-0 overflow-hidden flex flex-col h-[280px]">
                        <div class="p-3 border-b border-gray-800 bg-black/40 flex justify-between items-center">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Feed Real</h3>
                            <span class="text-[8px] bg-emerald-900 text-emerald-400 px-1 rounded">AO VIVO</span>
                        </div>
                        <div id="live-feed" class="flex-1 overflow-y-auto p-3 space-y-2">
                            </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, where, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CHAVES REAIS
        const firebaseConfig = { apiKey: "AIzaSyCga2CVSKysTYUpY3RDZNyV5BXhJe32lJQ", authDomain: "nucleo-insight-gerador.firebaseapp.com", projectId: "nucleo-insight-gerador", storageBucket: "nucleo-insight-gerador.firebasestorage.app", messagingSenderId: "159624822756", appId: "1:159624822756:web:279e5e1d4e0b80bc4991f1" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let chartInstance = null;
        let currentUser = null;

        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                loadData();
            }
        });

        window.loadData = async () => {
            const isTestView = document.getElementById('toggle-test').checked;
            const label = document.getElementById('mode-label');
            
            if(isTestView) { 
                label.innerText = "MEUS TESTES (ADMIN)"; label.className = "ml-2 text-[10px] font-bold text-yellow-500"; 
            } else { 
                label.innerText = "CLIENTES REAIS"; label.className = "ml-2 text-[10px] font-bold text-emerald-500"; 
            }

            const q = query(collection(db, "history"), orderBy("createdAt", "desc"), limit(100));
            const snapshot = await getDocs(q);
            
            let total = 0, riskSum = 0, modes = {}, users = new Set();
            let feedHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const isTestItem = data.isTest === true;

                if (isTestView && !isTestItem) return;
                if (!isTestView && isTestItem) return;

                total++;
                riskSum += data.boldness || 50;
                const modeName = (data.mode || 'Geral').toUpperCase();
                modes[modeName] = (modes[modeName] || 0) + 1;
                if(data.email) users.add(data.email);

                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000) : new Date();
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let icon = 'üé≤'; let colorClass = 'text-gray-400';
                if(data.mode === 'bicho') { icon = 'ü¶Å'; colorClass = 'text-yellow-500'; }
                if(data.mode === 'lotofacil') { icon = 'üçÄ'; colorClass = 'text-purple-500'; }

                feedHTML += `
                <div class="p-2 bg-zinc-900/30 rounded border border-white/5 flex justify-between items-center hover:bg-white/5 transition">
                    <div class="flex items-center gap-2">
                        <span class="${colorClass}">${icon}</span>
                        <div>
                            <div class="text-[10px] font-bold text-white">${modeName}</div>
                            <div class="text-[8px] text-gray-600">${data.email ? data.email.split('@')[0] : 'Anon'}</div>
                        </div>
                    </div>
                    <div class="text-[9px] text-yellow-600 font-mono">${time}</div>
                </div>`;
            });

            document.getElementById('live-feed').innerHTML = feedHTML || '<div class="text-center text-gray-700 text-xs py-10">Sem dados.</div>';
            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-sales').innerText = Math.floor(total * 0.05); 
            document.getElementById('kpi-risk').innerText = total ? Math.round(riskSum/total) + "%" : "0%";
            const bestMode = Object.keys(modes).length > 0 ? Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b) : '-';
            document.getElementById('kpi-fav').innerText = bestMode;

            renderDoughnutChart(modes);
            renderFunnel(total);
        }

        // --- SISTEMA DE LIMPEZA COM HIST√ìRICO ---
        window.openWipeModal = () => document.getElementById('wipe-modal').classList.remove('hidden');
        window.closeWipeModal = () => document.getElementById('wipe-modal').classList.add('hidden');

        window.confirmWipe = async () => {
            const wipeType = document.querySelector('input[name="wipeType"]:checked').value;
            const reason = document.getElementById('wipeReason').value.trim();
            const isTestDelete = wipeType === 'test';

            if (!reason) return alert("Por favor, digite o motivo da limpeza para salvar no hist√≥rico.");
            if (!confirm(`Tem certeza que deseja apagar TODOS os dados de ${wipeType.toUpperCase()}? Essa a√ß√£o √© irrevers√≠vel.`)) return;

            try {
                // 1. Busca os documentos para apagar
                const q = query(collection(db, "history"), where("isTest", "==", isTestDelete));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    alert("N√£o h√° dados desse tipo para apagar.");
                    closeWipeModal();
                    return;
                }

                // 2. Apaga um por um (Simples e seguro)
                let count = 0;
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                    count++;
                });
                await Promise.all(deletePromises);

                // 3. Salva no Log de Admin (Hist√≥rico)
                await addDoc(collection(db, "admin_logs"), {
                    action: "WIPE_DATA",
                    target: wipeType,
                    count: count,
                    reason: reason,
                    admin: currentUser.email,
                    timestamp: serverTimestamp()
                });

                alert(`Sucesso! ${count} registros foram apagados.\nMotivo registrado: "${reason}"`);
                closeWipeModal();
                loadData(); // Atualiza a tela

            } catch (error) {
                console.error(error);
                alert("Erro ao apagar: " + error.message);
            }
        };

        function renderFunnel(total) {
            const container = document.getElementById('funnel-container');
            if(total === 0) { container.innerHTML = '<div class="text-center text-gray-700 text-xs">Sem dados.</div>'; return; }
            
            const steps = [
                { label: "ACESSOS (ESTIMADO)", count: total * 3, color: "text-white" },
                { label: "GEROU JOGO", count: total, color: "text-yellow-400" },
                { label: "BATEU LIMITE (5)", count: Math.floor(total * 0.2), color: "text-red-400" },
                { label: "CLICOU CHECKOUT", count: Math.floor(total * 0.05), color: "text-emerald-400" }
            ];

            let html = '';
            steps.forEach((step, index) => {
                const max = steps[0].count;
                const width = (step.count / max) * 100;
                html += `
                <div class="funnel-step">
                    <div class="funnel-dot"></div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-[9px] font-bold text-gray-500">${step.label}</p>
                            <p class="text-lg font-black ${step.color}">${step.count}</p>
                        </div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: ${width}%"></div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderDoughnutChart(data) {
            const ctx = document.getElementById('gameChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            if(Object.keys(data).length === 0) data = {'Sem dados': 1};
            const colors = ['#eab308', '#a855f7', '#10b981', '#3b82f6'];
            const labels = Object.keys(data);
            const values = Object.values(data);

            const legendContainer = document.getElementById('legend-container');
            let legendHTML = '';
            labels.forEach((label, index) => {
                if(label === 'Sem dados') return;
                legendHTML += `
                <div class="flex items-center justify-between text-[9px] border-b border-white/5 pb-1">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${colors[index % colors.length]}"></span>
                        <span class="text-gray-400 uppercase">${label}</span>
                    </div>
                    <span class="text-white font-bold">${values[index]}</span>
                </div>`;
            });
            legendContainer.innerHTML = legendHTML;

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: values, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '85%',
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#000', bodyFont: { family: 'JetBrains Mono' } } }
                }
            });
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
