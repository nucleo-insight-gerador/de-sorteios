<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comando Central | Nucleo Insight</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.ibb.co/nMt8zB1d/LOGO-01.png">

    <style>
        body { background-color: #000000; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; background-image: radial-gradient(circle at 50% 0%, #1a1a00 0%, #000 70%); }
        .glass-panel { background: rgba(15, 15, 15, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 215, 0, 0.1); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .btn-tool { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; font-size: 11px; font-weight: bold; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }
        .btn-tool:hover { background: rgba(255,215,0,0.1); border-color: #ffd700; transform: translateY(-2px); color: #ffd700 !important; }
        .stat-card { border-left: 3px solid; padding-left: 15px; transition: transform 0.2s; }
        .stat-card:hover { transform: translateX(5px); }
        
        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #ffd700; }

        /* Anima√ß√£o de Pulso para Status */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .pulse-green { background: #10b981; box-shadow: 0 0 0 rgba(16, 185, 129, 0.4); animation: pulse-green 2s infinite; }
        .pulse-yellow { background: #eab308; box-shadow: 0 0 0 rgba(234, 179, 8, 0.4); animation: pulse-yellow 2s infinite; }
        
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="login-overlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="text-center p-8 border border-yellow-900/50 rounded-xl bg-zinc-900/50 backdrop-blur">
            <img src="https://i.ibb.co/nMt8zB1d/LOGO-01.png" class="w-16 h-16 mx-auto mb-4 animate-pulse">
            <h1 class="text-2xl text-yellow-500 font-black mb-1 tracking-widest">NUCLEO INSIGHT</h1>
            <p class="text-xs text-gray-500 mb-6">√ÅREA RESTRITA</p>
            <button id="btnLogin" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-yellow-400 hover:text-black transition flex items-center gap-2 mx-auto">
                <i data-lucide="lock" size="16"></i> Acessar Painel
            </button>
        </div>
    </div>

    <div id="dashboard" class="max-w-7xl mx-auto hidden animate-fade-in">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-800 pb-6 gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/nMt8zB1d/LOGO-01.png" class="w-12 h-12 border border-yellow-500/30 rounded-lg p-1">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-widest">COMANDO <span class="text-yellow-500">CENTRAL</span></h1>
                    <div class="flex items-center mt-1">
                        <span id="status-indicator" class="status-dot pulse-green"></span>
                        <p id="status-text" class="text-[10px] text-emerald-500 font-bold tracking-wider">SISTEMA OPERANTE</p>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 justify-center">
                <a href="https://clarity.microsoft.com/projects/view/v018s4v24n/dashboard" target="_blank" class="btn-tool text-orange-400">
                    <i data-lucide="flame" size="14"></i> CLARITY
                </a>
                <a href="https://console.firebase.google.com/u/0/project/nucleo-insight-gerador/analytics/dashboard" target="_blank" class="btn-tool text-yellow-400">
                    <i data-lucide="bar-chart-2" size="14"></i> ANALYTICS
                </a>
                <a href="https://business.facebook.com/events_manager" target="_blank" class="btn-tool text-blue-400">
                    <i data-lucide="facebook" size="14"></i> PIXEL
                </a>
            </div>
        </header>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-sm font-bold text-white flex items-center gap-2">
                <i data-lucide="layout-dashboard" size="16" class="text-yellow-500"></i> VIS√ÉO GERAL
            </h2>
            <div class="flex items-center gap-3 bg-zinc-900/80 p-2 rounded border border-zinc-800">
                <span class="text-[10px] text-gray-400 font-bold uppercase">Dados:</span>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-test" class="sr-only peer" onchange="loadData()">
                    <div class="w-10 h-5 bg-emerald-900 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600"></div>
                    <span id="mode-label" class="ml-2 text-[10px] font-bold text-emerald-500">CLIENTES (REAL)</span>
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 glass-panel h-[600px] flex flex-col">
                <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-black/40 rounded-t-lg">
                    <h3 class="text-[10px] font-bold text-gray-400 uppercase flex gap-2 items-center tracking-wider">
                        <i data-lucide="activity" size="12" class="text-yellow-500"></i> FEED EM TEMPO REAL
                    </h3>
                    <button onclick="loadData()" class="text-gray-500 hover:text-white transition"><i data-lucide="refresh-cw" size="12"></i></button>
                </div>
                <div id="live-feed" class="flex-1 overflow-y-auto p-3 space-y-2">
                    <div class="text-center py-10"><div class="inline-block animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-yellow-500"></div></div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-panel p-4 stat-card border-yellow-500 bg-gradient-to-br from-yellow-900/10 to-transparent">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Total Jogos</p>
                        <p id="kpi-total" class="text-3xl font-black text-white mt-1">0</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-blue-500 bg-gradient-to-br from-blue-900/10 to-transparent">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Modo Favorito</p>
                        <p id="kpi-fav" class="text-lg font-black text-white mt-2 truncate">...</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-purple-500 bg-gradient-to-br from-purple-900/10 to-transparent">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Ousadia M√©dia</p>
                        <p id="kpi-risk" class="text-3xl font-black text-white mt-1">0%</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-emerald-500 bg-gradient-to-br from-emerald-900/10 to-transparent">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Usu√°rios (Est.)</p>
                        <p id="kpi-users" class="text-3xl font-black text-white mt-1">0</p>
                    </div>
                </div>

                <div class="glass-panel p-6 flex flex-col md:flex-row items-center justify-between">
                    <div class="w-full md:w-1/2 mb-4 md:mb-0">
                        <h3 class="text-xs font-bold text-white mb-1 uppercase tracking-wider">Distribui√ß√£o de Jogos</h3>
                        <p class="text-[10px] text-gray-500">Prefer√™ncia dos usu√°rios por modalidade.</p>
                        
                        <div id="legend-container" class="mt-6 space-y-2">
                            </div>
                    </div>
                    <div class="w-48 h-48 relative">
                        <canvas id="gameChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-2xl font-bold text-white opacity-20">%</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURA√á√ÉO FIREBASE (J√Å CONFIGURADA)
        const firebaseConfig = { apiKey: "AIzaSyCga2CVSKysTYUpY3RDZNyV5BXhJe32lJQ", authDomain: "nucleo-insight-gerador.firebaseapp.com", projectId: "nucleo-insight-gerador", storageBucket: "nucleo-insight-gerador.firebasestorage.app", messagingSenderId: "159624822756", appId: "1:159624822756:web:279e5e1d4e0b80bc4991f1" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let chartInstance = null;

        // AUTH
        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                loadData();
            }
        });

        window.loadData = async () => {
            const isTestView = document.getElementById('toggle-test').checked;
            updateStatusVisuals(isTestView);

            const q = query(collection(db, "history"), orderBy("createdAt", "desc"), limit(100));
            const snapshot = await getDocs(q);
            
            let total = 0, riskSum = 0, modes = {}, users = new Set();
            let feedHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const isTestItem = data.isTest === true;

                // L√ìGICA DE FILTRO DO PAINEL
                if (isTestView && !isTestItem) return; // Se t√¥ vendo teste, ignora real
                if (!isTestView && isTestItem) return; // Se t√¥ vendo real, ignora teste

                total++;
                riskSum += data.boldness || 50;
                const modeName = (data.mode || 'desconhecido').toUpperCase();
                modes[modeName] = (modes[modeName] || 0) + 1;
                if(data.email) users.add(data.email);

                // Feed Item
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000) : new Date();
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let icon = 'üé≤'; let colorClass = 'text-gray-400';
                if(data.mode === 'bicho') { icon = 'ü¶Å'; colorClass = 'text-yellow-500'; }
                if(data.mode === 'lotofacil') { icon = 'üçÄ'; colorClass = 'text-purple-500'; }
                if(data.mode === 'mega') { icon = 'üí∞'; colorClass = 'text-emerald-500'; }

                feedHTML += `
                <div class="p-3 bg-zinc-900/50 rounded border border-white/5 flex justify-between items-center hover:bg-white/5 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center border border-white/10 group-hover:border-yellow-500/50 transition">${icon}</div>
                        <div>
                            <div class="text-[10px] font-bold text-white uppercase">${modeName}</div>
                            <div class="text-[9px] text-gray-600">${data.email ? data.email.split('@')[0] : 'Anon'}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-yellow-600 font-mono">${time}</div>
                        <div class="text-[9px] text-gray-700">Risco: ${data.boldness || 50}%</div>
                    </div>
                </div>`;
            });

            // Atualiza Interface
            document.getElementById('live-feed').innerHTML = feedHTML || '<div class="text-center text-gray-600 text-xs py-10 opacity-50">Sem dados nesta visualiza√ß√£o.</div>';
            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-users').innerText = users.size;
            document.getElementById('kpi-risk').innerText = total ? Math.round(riskSum/total) + "%" : "0%";
            const bestMode = Object.keys(modes).length > 0 ? Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b) : '-';
            document.getElementById('kpi-fav').innerText = bestMode;

            renderDoughnutChart(modes);
        }

        function updateStatusVisuals(isTest) {
            const label = document.getElementById('mode-label');
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-indicator');
            
            if(isTest) { 
                label.innerText = "MEUS TESTES (ADMIN)"; label.className = "ml-2 text-[10px] font-bold text-yellow-500"; 
                statusText.innerText = "MODO SANDBOX ATIVO"; statusText.className = "text-[10px] text-yellow-500 font-bold tracking-wider";
                statusDot.className = "status-dot pulse-yellow";
            } else { 
                label.innerText = "CLIENTES REAIS"; label.className = "ml-2 text-[10px] font-bold text-emerald-500"; 
                statusText.innerText = "SISTEMA OPERANTE"; statusText.className = "text-[10px] text-emerald-500 font-bold tracking-wider";
                statusDot.className = "status-dot pulse-green";
            }
        }

        function renderDoughnutChart(data) {
            const ctx = document.getElementById('gameChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            if(Object.keys(data).length === 0) data = {'Sem dados': 1};

            // Cores da Marca (Dourado, Roxo, Verde, Azul)
            const colors = ['#eab308', '#a855f7', '#10b981', '#3b82f6'];
            const labels = Object.keys(data);
            const values = Object.values(data);

            // Atualiza Legenda HTML
            const legendContainer = document.getElementById('legend-container');
            let legendHTML = '';
            labels.forEach((label, index) => {
                if(label === 'Sem dados') return;
                legendHTML += `
                <div class="flex items-center justify-between text-[10px]">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${colors[index % colors.length]}"></span>
                        <span class="text-gray-400">${label}</span>
                    </div>
                    <span class="text-white font-bold">${values[index]}</span>
                </div>`;
            });
            legendContainer.innerHTML = legendHTML || '<span class="text-[9px] text-gray-700">Aguardando dados...</span>';

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', // Estilo Rosca Fina (Moderno)
                    plugins: { 
                        legend: { display: false }, // Legenda Customizada via HTML
                        tooltip: {
                            backgroundColor: '#000',
                            titleColor: '#ffd700',
                            bodyFont: { family: 'JetBrains Mono' },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    let value = context.raw;
                                    let total = context.chart._metasets[context.datasetIndex].total;
                                    let percentage = Math.round((value / total) * 100) + '%';
                                    return label + value + ' (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
