<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comando Central | Nucleo Insight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: #111; border: 1px solid #333; border-radius: 8px; }
        .btn-tool { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .btn-tool:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .stat-card { border-left: 3px solid; padding-left: 15px; }
    </style>
</head>
<body class="p-6">

    <div id="login-overlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-2xl text-yellow-500 font-bold mb-4">ACESSO RESTRITO</h1>
            <button id="btnLogin" class="bg-white text-black px-6 py-3 rounded font-bold hover:bg-gray-200">
                Entrar com Google (Admin)
            </button>
        </div>
    </div>

    <div id="dashboard" class="max-w-7xl mx-auto hidden">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-800 pb-6">
            <div>
                <h1 class="text-2xl font-black text-white tracking-widest">NUCLEO <span class="text-yellow-500">INSIGHT</span></h1>
                <p class="text-xs text-gray-500 mt-1">SISTEMA DE INTELIG√äNCIA ESTRAT√âGICA</p>
            </div>
            
            <div class="flex gap-3 mt-4 md:mt-0">
                <a href="https://clarity.microsoft.com/projects/view/v018s4v24n/dashboard" target="_blank" class="btn-tool text-orange-400">
                    <i data-lucide="flame" size="14"></i> CLARITY (Gestos)
                </a>
                <a href="https://console.firebase.google.com/u/0/project/nucleo-insight-gerador/analytics/dashboard" target="_blank" class="btn-tool text-yellow-400">
                    <i data-lucide="bar-chart-2" size="14"></i> ANALYTICS (Tr√°fego)
                </a>
                <a href="https://business.facebook.com/events_manager" target="_blank" class="btn-tool text-blue-400">
                    <i data-lucide="facebook" size="14"></i> PIXEL (Ads)
                </a>
            </div>
        </header>

        <div class="flex justify-end mb-6">
            <div class="flex items-center gap-3 bg-zinc-900 p-2 rounded border border-zinc-800">
                <span class="text-[10px] text-gray-400 font-bold uppercase">Visualizar:</span>
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-test" class="sr-only peer" onchange="loadData()">
                    <div class="w-10 h-5 bg-emerald-900 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-600"></div>
                    <span id="mode-label" class="ml-2 text-xs font-bold text-emerald-500">CLIENTES REAIS</span>
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 glass-panel h-[600px] flex flex-col">
                <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-zinc-900/50 rounded-t-lg">
                    <h3 class="text-xs font-bold text-white flex gap-2 items-center"><i data-lucide="activity" size="14" class="text-green-500"></i> FEED DE GERA√á√ïES</h3>
                    <button onclick="loadData()" class="text-xs text-gray-500 hover:text-white"><i data-lucide="refresh-cw" size="12"></i></button>
                </div>
                <div id="live-feed" class="flex-1 overflow-y-auto p-4 space-y-2">
                    </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-panel p-4 stat-card border-yellow-500">
                        <p class="text-[10px] text-gray-500 uppercase">Total Jogos</p>
                        <p id="kpi-total" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-blue-500">
                        <p class="text-[10px] text-gray-500 uppercase">Modo Favorito</p>
                        <p id="kpi-fav" class="text-lg font-bold text-white truncate">...</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-purple-500">
                        <p class="text-[10px] text-gray-500 uppercase">Ousadia M√©dia</p>
                        <p id="kpi-risk" class="text-2xl font-bold text-white">0%</p>
                    </div>
                    <div class="glass-panel p-4 stat-card border-green-500">
                        <p class="text-[10px] text-gray-500 uppercase">Usu√°rios √önicos</p>
                        <p id="kpi-users" class="text-2xl font-bold text-white">0</p>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase">Distribui√ß√£o de Jogos</h3>
                    <div class="h-64">
                        <canvas id="gameChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CHAVES REAIS
        const firebaseConfig = { apiKey: "AIzaSyCga2CVSKysTYUpY3RDZNyV5BXhJe32lJQ", authDomain: "nucleo-insight-gerador.firebaseapp.com", projectId: "nucleo-insight-gerador", storageBucket: "nucleo-insight-gerador.firebasestorage.app", messagingSenderId: "159624822756", appId: "1:159624822756:web:279e5e1d4e0b80bc4991f1" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let chartInstance = null;

        // LOGIN DO ADMIN
        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
            }
        });

        window.loadData = async () => {
            const isTestView = document.getElementById('toggle-test').checked;
            const label = document.getElementById('mode-label');
            
            if(isTestView) { label.innerText = "MEUS TESTES (ADMIN)"; label.className = "ml-2 text-xs font-bold text-yellow-500"; }
            else { label.innerText = "CLIENTES REAIS"; label.className = "ml-2 text-xs font-bold text-emerald-500"; }

            const q = query(collection(db, "history"), orderBy("createdAt", "desc"), limit(200));
            const snapshot = await getDocs(q);
            
            let total = 0, riskSum = 0, modes = {}, users = new Set();
            let feedHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const isTestItem = data.isTest === true;

                // FILTRO INTELIGENTE
                if (isTestView && !isTestItem) return; // Quer teste, mas √© real -> Pula
                if (!isTestView && isTestItem) return; // Quer real, mas √© teste -> Pula

                total++;
                riskSum += data.boldness || 50; // Se n√£o tiver, assume 50 (legacy)
                modes[data.mode] = (modes[data.mode] || 0) + 1;
                if(data.email) users.add(data.email);

                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000) : new Date();
                const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let icon = 'üé≤';
                if(data.mode === 'bicho') icon = 'ü¶Å';
                if(data.mode === 'lotofacil') icon = 'üçÄ';

                feedHTML += `
                <div class="p-3 bg-white/5 rounded border border-white/5 flex justify-between items-center hover:bg-white/10 transition">
                    <div>
                        <div class="text-xs text-white font-bold mb-1">${icon} ${data.mode.toUpperCase()}</div>
                        <div class="text-[10px] text-gray-500">${data.email.split('@')[0]}...</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-yellow-500 font-mono">${time}</div>
                        <div class="text-[9px] text-gray-600">Risco: ${data.boldness || 50}%</div>
                    </div>
                </div>`;
            });

            document.getElementById('live-feed').innerHTML = feedHTML || '<div class="text-center text-gray-600 text-xs py-10">Nenhum dado.</div>';
            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-users').innerText = users.size;
            document.getElementById('kpi-risk').innerText = total ? Math.round(riskSum/total) + "%" : "0%";
            
            const bestMode = Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b, '-');
            document.getElementById('kpi-fav').innerText = bestMode.toUpperCase();

            renderChart(modes);
        }

        function renderChart(data) {
            const ctx = document.getElementById('gameChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            if(Object.keys(data).length === 0) data = {'Sem dados': 1};

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data).map(k => k.toUpperCase()),
                    datasets: [{
                        label: 'Jogos',
                        data: Object.values(data),
                        backgroundColor: '#ffd700',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
